(function(){"use strict";class _{constructor(){this.isProcessing=!1,this.progressCallback=null}processCSV(e,i){const s=e.split(`
`).filter(r=>r.trim());if(s.length<2)throw new Error("CSV file must have at least a header row and one data row");const o=this.parseCSVLine(s[0]).map(r=>this.normalizeHeader(r)),n=i.filter(r=>!o.includes(r));n.length>0&&console.warn(`Missing expected columns: ${n.join(", ")}. Processing with available columns.`);const t=[],a=s.length-1;for(let r=1;r<s.length;r++){const d=s[r].trim();if(!d)continue;const u=this.parseCSVLine(d),m={};o.forEach((l,c)=>{m[l]=u[c]||""}),t.push(m),r%100===0&&this.reportProgress(r/a*100,`Processed ${r} rows`)}return t}processExcel(e,i){if(e.length<2)throw new Error("Excel file must have at least a header row and one data row");const s=e[0].map(a=>this.normalizeHeader(a));console.log("Available headers in Excel file:",s),console.log("Expected columns:",i);const o=i.filter(a=>!s.includes(a));o.length>0&&console.warn(`Missing expected columns: ${o.join(", ")}. Processing with available columns.`);const n=[],t=e.length-1;for(let a=1;a<e.length;a++){const r=e[a];if(!r||!Array.isArray(r)||!r.slice(0,5).some(l=>l!=null&&String(l).trim()!==""))continue;const u={};s.forEach((l,c)=>{let p=r[c]!==null&&r[c]!==void 0?String(r[c]).trim():"";u[l]=p}),a<=3&&console.log(`Excel Row ${a} data:`,{...u,productName:u.item_productName,productDescription:u.item_productDescription,hsCode:u.item_hsCode,quantity:u.item_quantity,unitPrice:u.item_unitPrice,buyerBusinessName:u.buyerBusinessName,buyerNTNCNIC:u.buyerNTNCNIC});const m=String(u.invoiceType||u.invoice_type||"").trim().toLowerCase();m.includes("total")||m.includes("instruction")||m.includes("summary")||m.includes("note")||m.includes("auto-calculates")||m.includes("enter ")||m.includes("use the")||m.includes("dropdown")||m.includes("validated")||m.includes("hardcoded")||m.includes("fallback")||/^\d+\.\s/.test(m)||/^[a-z]\.\s/i.test(m)||(this.hasMeaningfulDataFlexible(u,s,a-1)&&n.push(u),a%100===0&&this.reportProgress(a/t*100,`Processed ${a} rows`))}return console.log(`Processed ${n.length} meaningful rows from ${t} total rows`),n.length>0&&console.log("üîç Worker Debug: Sample processed row:",{productName:n[0].item_productName,hsCode:n[0].item_hsCode,quantity:n[0].item_quantity,unitPrice:n[0].item_unitPrice,totalValues:n[0].item_totalValues,buyerBusinessName:n[0].buyerBusinessName}),n}parseCSVLine(e){const i=[];let s="",o=!1;for(let n=0;n<e.length;n++){const t=e[n];t==='"'?o&&e[n+1]==='"'?(s+='"',n++):o=!o:t===","&&!o?(i.push(s.trim()),s=""):s+=t}return i.push(s.trim()),i}normalizeHeader(e){const i=String(e||"").trim(),s={"Invoice Type":"invoiceType","Invoice Date":"invoiceDate","Invoice Ref No":"invoiceRefNo","Company Invoice Ref No":"companyInvoiceRefNo","Buyer NTN/CNIC":"buyerNTNCNIC","Buyer Buisness Name":"buyerBusinessName","Buyer Province":"buyerProvince","Buyer Address":"buyerAddress","Buyer Registration Type":"buyerRegistrationType","Transaction Type":"transctypeId",Rate:"item_rate","SRO Schedule No":"item_sroScheduleNo","SRO Item No":"item_sroItemSerialNo","Sale Type":"item_saleType","HS Code":"item_hsCode","Unit Of Measurement":"item_uoM","Product Name":"item_productName","Product Description":"item_productDescription","Value Sales (Excl ST)":"item_valueSalesExcludingST",Quantity:"item_quantity","Unit Cost":"item_unitPrice","Sales Tax Applicable":"item_salesTaxApplicable","ST Withheld at Source":"item_salesTaxWithheldAtSource","Extra Tax":"item_extraTax","Further Tax":"item_furtherTax","FED Payable":"item_fedPayable",Discount:"item_discount","Total Values":"item_totalValues"};if(s[i])return s[i];const o={"Invoice Da":"invoiceDate","Invoice Re":"invoiceRefNo","Company I":"companyInvoiceRefNo","Buyer NTN":"buyerNTNCNIC","Buyer Buis":"buyerBusinessName","Buyer Prov":"buyerProvince","Buyer Addƒ±":"buyerAddress","Buyer Regi":"buyerRegistrationType",Transactio:"transctypeId","SRO Sched":"item_sroScheduleNo","SRO Item":"item_sroItemSerialNo","Product Na":"item_productName","Product De":"item_productDescription","Value Sale":"item_valueSalesExcludingST","Unit Of Me":"item_uoM","Sales Tax":"item_salesTaxApplicable","ST Withheld":"item_salesTaxWithheldAtSource","FED Payab":"item_fedPayable","Total Valu":"item_totalValues"};return o[i]?o[i]:i.toLowerCase().trim().replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}hasMeaningfulData(e,i){const s=e.invoiceType&&e.invoiceType.trim()!==""&&e.invoiceType!=="Standard"||e.invoiceDate&&e.invoiceDate.trim()!==""||e.companyInvoiceRefNo&&e.companyInvoiceRefNo.trim()!==""&&e.companyInvoiceRefNo!==`row_${i+1}`||e.buyerBusinessName&&e.buyerBusinessName.trim()!==""&&e.buyerBusinessName!=="Unknown Buyer"||e.buyerNTNCNIC&&e.buyerNTNCNIC.trim()!=="",o=e.item_productName&&e.item_productName.trim()!==""||e.item_hsCode&&e.item_hsCode.trim()!==""||e.item_quantity&&e.item_quantity!==""&&e.item_quantity!=="0"&&e.item_quantity!==0||e.item_unitPrice&&e.item_unitPrice!==""&&e.item_unitPrice!=="0"&&e.item_unitPrice!==0||e.item_totalValues&&e.item_totalValues!==""&&e.item_totalValues!=="0"&&e.item_totalValues!==0||e.item_valueSalesExcludingST&&e.item_valueSalesExcludingST!==""&&e.item_valueSalesExcludingST!=="0"&&e.item_valueSalesExcludingST!==0;return s||o}hasMeaningfulDataFlexible(e,i,s){const o=Object.values(e).some(l=>{const c=String(l).trim();return c!==""&&c!=="0"&&c!=="null"&&c!=="undefined"});if(!o)return!1;const n=["auto-calculates","enter ","use the","dropdown","validated","hardcoded","fallback","unit cost","value sales","sales tax","computed","computed as","divided by"];if(Object.values(e).some(l=>{const c=String(l).toLowerCase();return n.some(p=>c.includes(p))})||Object.values(e).some(l=>{const c=String(l).trim();return/^\d+\.\s/.test(c)||/^[a-z]\.\s/i.test(c)}))return!1;const r=["invoice","bill","receipt","order","purchase","sale","product","item","quantity","price","amount","total"],d=Object.values(e).some(l=>{const c=String(l).toLowerCase();return r.some(p=>c.includes(p))}),u=Object.values(e).some(l=>{const c=String(l).trim(),p=parseFloat(c);return!isNaN(p)&&p>0}),m=Object.values(e).some(l=>{const c=String(l).trim();return/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/.test(c)||/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(c)});return o&&(d||u||m)}groupInvoices(e){const i=new Map,s=[],o=[];e.forEach((t,a)=>{try{const r=t.companyInvoiceRefNo?.trim()||t.company_invoice_ref_no?.trim()||t.invoice_ref_no?.trim()||t.internalInvoiceNo?.trim()||t.internal_invoice_no?.trim()||t.invoiceNumber?.trim()||t.invoice_number?.trim()||`row_${a+1}`;if(i.has(r))i.get(r).items.push(this.cleanItemData(t,a));else{const d=t.buyerBusinessName||t.buyer_business_name||t.buyer_buisness_name||"";a<3&&console.log(`üîç Worker Debug: Creating invoice ${a+1}:`,{companyInvoiceRefNo:r,buyerBusinessName:d,buyerNTNCNIC:t.buyerNTNCNIC||t.buyer_ntn_cnic||"",availableFields:Object.keys(t).filter(u=>u.toLowerCase().includes("buyer"))}),i.set(r,{invoiceType:t.invoiceType||t.invoice_type||"Standard",invoiceDate:t.invoiceDate||t.invoice_date||new Date().toISOString().split("T")[0],companyInvoiceRefNo:r,internalInvoiceNo:t.internalInvoiceNo||t.internal_invoice_no||t.invoiceNumber||t.invoice_number||`INT-${a+1}`,buyerBusinessName:d,buyerNTNCNIC:t.buyerNTNCNIC||t.buyer_ntn_cnic||"",buyerProvince:t.buyerProvince||t.buyer_province||"",buyerAddress:t.buyerAddress||t.buyer_address||"",buyerRegistrationType:t.buyerRegistrationType||t.buyer_registration_type||"Individual",items:[this.cleanItemData(t,a)]})}}catch(r){s.push({row:a+1,message:r.message})}});const n=Array.from(i.values());return n.length>0&&console.log("üîç Worker Debug: Final invoice data:",{totalInvoices:n.length,sampleInvoice:{companyInvoiceRefNo:n[0].companyInvoiceRefNo,buyerBusinessName:n[0].buyerBusinessName,itemsCount:n[0].items?.length||0,sampleItem:n[0].items?.[0]?{item_productName:n[0].items[0].item_productName,item_hsCode:n[0].items[0].item_hsCode,item_quantity:n[0].items[0].item_quantity,item_unitPrice:n[0].items[0].item_unitPrice,item_totalValues:n[0].items[0].item_totalValues}:null}}),{invoices:n,errors:s,warnings:o}}cleanHsCode(e){if(!e||String(e).trim()===""||String(e).trim()==="N/A")return"";const i=String(e).trim();if(console.log("üîç Worker cleanHsCode input:",i.substring(0,100)+(i.length>100?"...":"")),i.includes(" - ")){const o=i.split(" - ")[0].trim();return console.log("üîç Worker cleanHsCode output:",o),o}return console.log("üîç Worker cleanHsCode output (no dash):",i),i}cleanItemData(e,i){const s={...e};return["quantity","unitPrice","totalValues","valueSalesExcludingST","fixedNotifiedValueOrRetailPrice","salesTaxApplicable","extraTax","furtherTax","fedPayable","discount","item_quantity","item_unitPrice","item_totalValues","item_valueSalesExcludingST","item_salesTaxApplicable","item_extraTax","item_furtherTax","item_fedPayable","item_discount"].forEach(t=>{if(s[t]!==void 0&&s[t]!==null&&s[t]!==""){const a=parseFloat(s[t]);s[t]=isNaN(a)?0:a}else s[t]=0}),Object.entries({item_productName:"name",item_hsCode:"hsCode",item_productDescription:"productDescription",item_quantity:"quantity",item_unitPrice:"unitPrice",item_totalValues:"totalValues",item_valueSalesExcludingST:"valueSalesExcludingST",item_salesTaxApplicable:"salesTaxApplicable",item_extraTax:"extraTax",item_furtherTax:"furtherTax",item_fedPayable:"fedPayable",item_discount:"discount",item_uoM:"uoM",item_rate:"rate"}).forEach(([t,a])=>{if(s[t]!==void 0){let r=s[t];t==="item_hsCode"&&(r=this.cleanHsCode(r)),s[a]=r,s[t]=r}}),s._row=i+1,s}reportProgress(e,i){this.progressCallback&&this.progressCallback(e,i),self.postMessage({type:"progress",percentage:e,message:i})}async process(e){if(this.isProcessing)throw new Error("Already processing a file");this.isProcessing=!0;try{this.reportProgress(0,"Starting file processing...");let i;if(e.type==="csv")this.reportProgress(10,"Parsing CSV file..."),i=this.processCSV(e.content,e.expectedColumns);else if(e.type==="excel")this.reportProgress(10,"Processing Excel data..."),i=this.processExcel(e.jsonData,e.expectedColumns);else throw new Error("Unsupported file type");this.reportProgress(70,"Grouping invoices...");const s=this.groupInvoices(i);return this.reportProgress(100,"Processing complete!"),{success:!0,data:s,totalRows:i.length,invoiceCount:s.invoices.length,errorCount:s.errors.length,warningCount:s.warnings.length}}catch(i){return{success:!1,error:i.message}}finally{this.isProcessing=!1}}}const y=new _;self.onmessage=async function(h){const{type:e,data:i}=h.data;switch(e){case"process":try{const s=await y.process(i);self.postMessage({type:"result",data:s})}catch(s){self.postMessage({type:"error",error:s.message})}break;case"cancel":y.isProcessing=!1,self.postMessage({type:"cancelled"});break}}})();
