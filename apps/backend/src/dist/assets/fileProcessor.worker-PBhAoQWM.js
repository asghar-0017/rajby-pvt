(function(){"use strict";class g{constructor(){this.isProcessing=!1,this.progressCallback=null}processCSV(e,i){const t=e.split(`
`).filter(c=>c.trim());if(t.length<2)throw new Error("CSV file must have at least a header row and one data row");const l=this.parseCSVLine(t[0]).map(c=>this.normalizeHeader(c)),a=i.filter(c=>!l.includes(c));a.length>0&&console.warn(`Missing expected columns: ${a.join(", ")}. Processing with available columns.`);const s=[],u=t.length-1;for(let c=1;c<t.length;c++){const n=t[c].trim();if(!n)continue;const d=this.parseCSVLine(n),_={};l.forEach((o,r)=>{_[o]=d[r]||""}),s.push(_),c%100===0&&this.reportProgress(c/u*100,`Processed ${c} rows`)}return s}processExcel(e,i){if(e.length<2)throw new Error("Excel file must have at least a header row and one data row");const t=e[0].map(n=>this.normalizeHeader(n));console.log("Available headers in Excel file:",t),console.log("Expected columns:",i);const l=t.filter(n=>n.includes("dcDoc"));console.log("DC Doc related headers found:",l);const a=t.filter(n=>n.toLowerCase().includes("dc")||n.toLowerCase().includes("doc")||n.toLowerCase().includes("document"));console.log("All DC/Doc related headers found:",a),console.log("Raw headers from Excel (before normalization):",e[0]);const s=i.filter(n=>!t.includes(n));s.length>0&&console.warn(`Missing expected columns: ${s.join(", ")}. Processing with available columns.`);const u=[],c=e.length-1;for(let n=1;n<e.length;n++){const d=e[n];if(!d||!Array.isArray(d)||!d.slice(0,5).some(m=>m!=null&&String(m).trim()!==""))continue;const o={};t.forEach((m,p)=>{let f=d[p]!==null&&d[p]!==void 0?String(d[p]).trim():"";o[m]=f}),n<=3&&console.log(`Excel Row ${n} data:`,{...o,productName:o.item_productName,productDescription:o.item_productDescription,hsCode:o.item_hsCode,quantity:o.item_quantity,unitPrice:o.item_unitPrice,buyerBusinessName:o.buyerBusinessName,buyerNTNCNIC:o.buyerNTNCNIC,dcDocId:o.item_dcDocId,dcDocDate:o.item_dcDocDate});const r=String(o.invoiceType||o.invoice_type||"").trim().toLowerCase();r.includes("total")||r.includes("instruction")||r.includes("summary")||r.includes("note")||r.includes("auto-calculates")||r.includes("enter ")||r.includes("use the")||r.includes("dropdown")||r.includes("validated")||r.includes("hardcoded")||r.includes("fallback")||/^\d+\.\s/.test(r)||/^[a-z]\.\s/i.test(r)||(this.hasMeaningfulDataFlexible(o,t,n-1)&&u.push(o),n%100===0&&this.reportProgress(n/c*100,`Processed ${n} rows`))}return console.log(`Processed ${u.length} meaningful rows from ${c} total rows`),u.length>0&&console.log("üîç Worker Debug: Sample processed row:",{productName:u[0].item_productName,hsCode:u[0].item_hsCode,quantity:u[0].item_quantity,unitPrice:u[0].item_unitPrice,totalValues:u[0].item_totalValues,buyerBusinessName:u[0].buyerBusinessName}),u}parseCSVLine(e){const i=[];let t="",l=!1;for(let a=0;a<e.length;a++){const s=e[a];s==='"'?l&&e[a+1]==='"'?(t+='"',a++):l=!l:s===","&&!l?(i.push(t.trim()),t=""):t+=s}return i.push(t.trim()),i}normalizeHeader(e){const i=String(e||"").trim(),t={"Invoice Type":"invoiceType","Invoice Date":"invoiceDate","Invoice Ref No":"invoiceRefNo","Company Invoice Ref No":"companyInvoiceRefNo","Buyer NTN/CNIC":"buyerNTNCNIC","Buyer Buisness Name":"buyerBusinessName","Buyer Province":"buyerProvince","Buyer Address":"buyerAddress","Buyer Registration Type":"buyerRegistrationType","Buyer Telephone No":"buyerTelephone","Transaction Type":"transctypeId",Rate:"item_rate","SRO Schedule No":"item_sroScheduleNo","SRO Item No":"item_sroItemSerialNo","DC Doc Id":"item_dcDocId","DC Doc Date":"item_dcDocDate","Sale Type":"item_saleType","HS Code":"item_hsCode","Unit Of Measurement":"item_uoM","Product Name":"item_productName","Product Description":"item_productDescription","Value Sales (Excl ST)":"item_valueSalesExcludingST",Quantity:"item_quantity","Unit Cost":"item_unitPrice","Sales Tax Applicable":"item_salesTaxApplicable","ST Withheld at Source":"item_salesTaxWithheldAtSource","Extra Tax":"item_extraTax","Further Tax":"item_furtherTax","FED Payable":"item_fedPayable",Discount:"item_discount","Total Values":"item_totalValues"};if(t[i])return t[i];const l={"Invoice Da":"invoiceDate","Invoice Re":"invoiceRefNo","Company I":"companyInvoiceRefNo","Buyer NTN":"buyerNTNCNIC","Buyer Buis":"buyerBusinessName","Buyer Prov":"buyerProvince","Buyer Addƒ±":"buyerAddress","Buyer Regi":"buyerRegistrationType","Buyer Tele":"buyerTelephone",Transactio:"transctypeId","SRO Sched":"item_sroScheduleNo","SRO Item":"item_sroItemSerialNo","DC Doc I":"item_dcDocId","DC Doc Da":"item_dcDocDate","Product Na":"item_productName","Product De":"item_productDescription","Value Sale":"item_valueSalesExcludingST","Unit Of Me":"item_uoM","Sales Tax":"item_salesTaxApplicable","ST Withheld":"item_salesTaxWithheldAtSource","FED Payab":"item_fedPayable","Total Valu":"item_totalValues"};return l[i]?l[i]:i.toLowerCase().trim().replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}hasMeaningfulData(e,i){const t=e.invoiceType&&e.invoiceType.trim()!==""&&e.invoiceType!=="Standard"||e.invoiceDate&&e.invoiceDate.trim()!==""||e.companyInvoiceRefNo&&e.companyInvoiceRefNo.trim()!==""&&e.companyInvoiceRefNo!==`row_${i+1}`||e.buyerBusinessName&&e.buyerBusinessName.trim()!==""&&e.buyerBusinessName!=="Unknown Buyer"||e.buyerNTNCNIC&&e.buyerNTNCNIC.trim()!=="",l=e.item_productName&&e.item_productName.trim()!==""||e.item_hsCode&&e.item_hsCode.trim()!==""||e.item_quantity&&e.item_quantity!==""&&e.item_quantity!=="0"&&e.item_quantity!==0||e.item_unitPrice&&e.item_unitPrice!==""&&e.item_unitPrice!=="0"&&e.item_unitPrice!==0||e.item_totalValues&&e.item_totalValues!==""&&e.item_totalValues!=="0"&&e.item_totalValues!==0||e.item_valueSalesExcludingST&&e.item_valueSalesExcludingST!==""&&e.item_valueSalesExcludingST!=="0"&&e.item_valueSalesExcludingST!==0;return t||l}hasMeaningfulDataFlexible(e,i,t){const l=Object.values(e).some(o=>{const r=String(o).trim();return r!==""&&r!=="0"&&r!=="null"&&r!=="undefined"});if(!l)return!1;const a=["auto-calculates","enter ","use the","dropdown","validated","hardcoded","fallback","unit cost","value sales","sales tax","computed","computed as","divided by"];if(Object.values(e).some(o=>{const r=String(o).toLowerCase();return a.some(m=>r.includes(m))})||Object.values(e).some(o=>{const r=String(o).trim();return/^\d+\.\s/.test(r)||/^[a-z]\.\s/i.test(r)}))return!1;const c=["invoice","bill","receipt","order","purchase","sale","product","item","quantity","price","amount","total"],n=Object.values(e).some(o=>{const r=String(o).toLowerCase();return c.some(m=>r.includes(m))}),d=Object.values(e).some(o=>{const r=String(o).trim(),m=parseFloat(r);return!isNaN(m)&&m>0}),_=Object.values(e).some(o=>{const r=String(o).trim();return/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/.test(r)||/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(r)});return l&&(n||d||_)}groupInvoices(e){const i=new Map,t=[],l=[];e.forEach((s,u)=>{try{const c=s.companyInvoiceRefNo?.trim()||s.company_invoice_ref_no?.trim()||s.invoice_ref_no?.trim()||s.internalInvoiceNo?.trim()||s.internal_invoice_no?.trim()||s.invoiceNumber?.trim()||s.invoice_number?.trim()||`row_${u+1}`;if(i.has(c))i.get(c).items.push(this.cleanItemData(s,u));else{const n=s.buyerBusinessName||s.buyer_business_name||s.buyer_buisness_name||"";u<3&&console.log(`üîç Worker Debug: Creating invoice ${u+1}:`,{companyInvoiceRefNo:c,buyerBusinessName:n,buyerNTNCNIC:s.buyerNTNCNIC||s.buyer_ntn_cnic||"",availableFields:Object.keys(s).filter(d=>d.toLowerCase().includes("buyer"))}),i.set(c,{invoiceType:s.invoiceType||s.invoice_type||"Standard",invoiceDate:s.invoiceDate||s.invoice_date||new Date().toISOString().split("T")[0],companyInvoiceRefNo:c,internalInvoiceNo:s.internalInvoiceNo||s.internal_invoice_no||s.invoiceNumber||s.invoice_number||`INT-${u+1}`,buyerBusinessName:n,buyerNTNCNIC:s.buyerNTNCNIC||s.buyer_ntn_cnic||"",buyerProvince:s.buyerProvince||s.buyer_province||"",buyerAddress:s.buyerAddress||s.buyer_address||"",buyerRegistrationType:s.buyerRegistrationType||s.buyer_registration_type||"Individual",buyerTelephone:s.buyerTelephone||s.buyer_telephone_no||s.buyer_telephone||"",items:[this.cleanItemData(s,u)]})}}catch(c){t.push({row:u+1,message:c.message})}});const a=Array.from(i.values());return a.length>0&&console.log("üîç Worker Debug: Final invoice data:",{totalInvoices:a.length,sampleInvoice:{companyInvoiceRefNo:a[0].companyInvoiceRefNo,buyerBusinessName:a[0].buyerBusinessName,itemsCount:a[0].items?.length||0,sampleItem:a[0].items?.[0]?{item_productName:a[0].items[0].item_productName,item_hsCode:a[0].items[0].item_hsCode,item_quantity:a[0].items[0].item_quantity,item_unitPrice:a[0].items[0].item_unitPrice,item_totalValues:a[0].items[0].item_totalValues}:null}}),{invoices:a,errors:t,warnings:l}}cleanHsCode(e){if(!e||String(e).trim()===""||String(e).trim()==="N/A")return"";const i=String(e).trim();if(console.log("üîç Worker cleanHsCode input:",i.substring(0,100)+(i.length>100?"...":"")),i.includes(" - ")){const l=i.split(" - ")[0].trim();return console.log("üîç Worker cleanHsCode output:",l),l}return console.log("üîç Worker cleanHsCode output (no dash):",i),i}cleanItemData(e,i){i<3&&console.log(`üîç Worker Debug: Processing item ${i+1}:`,{item_cartages:e.item_cartages,item_others:e.item_others,cartages:e.cartages,others:e.others,allKeys:Object.keys(e).filter(a=>a.includes("cartages")||a.includes("others"))});const t={productName:e.productName||e.item_productName||e.name||"",name:e.name||e.item_productName||e.productName||"",hsCode:e.hsCode||e.item_hsCode||"",productDescription:e.productDescription||e.item_productDescription||"",rate:e.rate||e.item_rate||0,uoM:e.uoM||e.item_uoM||"",quantity:e.quantity||e.item_quantity||0,unitPrice:e.unitPrice||e.item_unitPrice||0,totalValues:e.totalValues||e.item_totalValues||0,valueSalesExcludingST:e.valueSalesExcludingST||e.item_valueSalesExcludingST||0,fixedNotifiedValueOrRetailPrice:e.fixedNotifiedValueOrRetailPrice||e.item_fixedNotifiedValueOrRetailPrice||0,salesTaxApplicable:e.salesTaxApplicable||e.item_salesTaxApplicable||0,extraTax:e.extraTax||e.item_extraTax||0,furtherTax:e.furtherTax||e.item_furtherTax||0,sroScheduleNo:e.sroScheduleNo||e.item_sroScheduleNo||"",fedPayable:e.fedPayable||e.item_fedPayable||0,discount:e.discount||e.item_discount||0,cartages:e.item_cartages||e.cartages||0,others:e.item_others||e.others||0,saleType:e.saleType||e.item_saleType||"",sroItemSerialNo:e.sroItemSerialNo||e.item_sroItemSerialNo||"",dcDocId:e.dcDocId||e.item_dcDocId||"",dcDocDate:e.dcDocDate||e.item_dcDocDate||"",item_rate:e.item_rate||0,item_sroScheduleNo:e.item_sroScheduleNo||"",item_sroItemSerialNo:e.item_sroItemSerialNo||"",item_saleType:e.item_saleType||"",item_hsCode:e.item_hsCode||"",item_uoM:e.item_uoM||"",item_productName:e.item_productName||"",item_productDescription:e.item_productDescription||"",item_valueSalesExcludingST:e.item_valueSalesExcludingST||0,item_quantity:e.item_quantity||0,item_unitPrice:e.item_unitPrice||0,item_salesTaxApplicable:e.item_salesTaxApplicable||0,item_salesTaxWithheldAtSource:e.item_salesTaxWithheldAtSource||0,item_extraTax:e.item_extraTax||0,item_furtherTax:e.item_furtherTax||0,item_fedPayable:e.item_fedPayable||0,item_discount:e.item_discount||0,item_cartages:e.item_cartages||e.cartages||0,item_others:e.item_others||e.others||0,item_totalValues:e.item_totalValues||0,item_dcDocId:e.item_dcDocId||"",item_dcDocDate:e.item_dcDocDate||"",item_fixedNotifiedValueOrRetailPrice:e.item_fixedNotifiedValueOrRetailPrice||0,transctypeId:e.transctypeId||"",_row:i+1};if(["quantity","unitPrice","totalValues","valueSalesExcludingST","fixedNotifiedValueOrRetailPrice","salesTaxApplicable","extraTax","furtherTax","fedPayable","discount","item_quantity","item_unitPrice","item_totalValues","item_valueSalesExcludingST","item_salesTaxApplicable","item_extraTax","item_furtherTax","item_fedPayable","item_discount"].forEach(a=>{if(t[a]!==void 0&&t[a]!==null&&t[a]!==""){const s=parseFloat(t[a]);t[a]=isNaN(s)?0:s}else t[a]=0}),t.hsCode&&(t.hsCode=this.cleanHsCode(t.hsCode)),t.item_hsCode&&(t.item_hsCode=this.cleanHsCode(t.item_hsCode)),t.transctypeId){const a=String(t.transctypeId).trim();if(a.includes(" - ")){const s=a.split(" - ");t.transctypeId=s[0].trim()}}return i<3&&console.log(`üîç Worker Debug: Cleaned item ${i+1}:`,{cartages:t.cartages,others:t.others,item_cartages:t.item_cartages,item_others:t.item_others}),t}reportProgress(e,i){this.progressCallback&&this.progressCallback(e,i),self.postMessage({type:"progress",percentage:e,message:i})}async process(e){if(this.isProcessing)throw new Error("Already processing a file");this.isProcessing=!0;try{this.reportProgress(0,"Starting file processing...");let i;if(e.type==="csv")this.reportProgress(10,"Parsing CSV file..."),i=this.processCSV(e.content,e.expectedColumns);else if(e.type==="excel")this.reportProgress(10,"Processing Excel data..."),i=this.processExcel(e.jsonData,e.expectedColumns);else throw new Error("Unsupported file type");this.reportProgress(70,"Grouping invoices...");const t=this.groupInvoices(i);return this.reportProgress(100,"Processing complete!"),{success:!0,data:t,totalRows:i.length,invoiceCount:t.invoices.length,errorCount:t.errors.length,warningCount:t.warnings.length}}catch(i){return{success:!1,error:i.message}}finally{this.isProcessing=!1}}}const h=new g;self.onmessage=async function(y){const{type:e,data:i}=y.data;switch(e){case"process":try{const t=await h.process(i);self.postMessage({type:"result",data:t})}catch(t){self.postMessage({type:"error",error:t.message})}break;case"cancel":h.isProcessing=!1,self.postMessage({type:"cancelled"});break}}})();
