(function(){"use strict";class h{constructor(){this.isProcessing=!1,this.progressCallback=null}processCSV(e,s){const i=e.split(`
`).filter(n=>n.trim());if(i.length<2)throw new Error("CSV file must have at least a header row and one data row");const c=this.parseCSVLine(i[0]).map(n=>this.normalizeHeader(n)),r=s.filter(n=>!c.includes(n));r.length>0&&console.warn(`Missing expected columns: ${r.join(", ")}. Processing with available columns.`);const t=[],a=i.length-1;for(let n=1;n<i.length;n++){const l=i[n].trim();if(!l)continue;const o=this.parseCSVLine(l),u={};c.forEach((m,d)=>{u[m]=o[d]||""}),t.push(u),n%100===0&&this.reportProgress(n/a*100,`Processed ${n} rows`)}return t}processExcel(e,s){if(e.length<2)throw new Error("Excel file must have at least a header row and one data row");const i=e[0].map(a=>this.normalizeHeader(a));console.log("Available headers in Excel file:",i),console.log("Expected columns:",s);const c=s.filter(a=>!i.includes(a));c.length>0&&console.warn(`Missing expected columns: ${c.join(", ")}. Processing with available columns.`),e[0].forEach((a,n)=>{i[n]});const r=[],t=e.length-1;for(let a=1;a<e.length;a++){const n=e[a];if(!n||!Array.isArray(n)||!n.slice(0,5).some(d=>d!=null&&String(d).trim()!==""))continue;const o={};i.forEach((d,_)=>{let f=n[_]!==null&&n[_]!==void 0?String(n[_]).trim():"";o[d]=f}),a<=3&&console.log(`Excel Row ${a} data:`,{...o,productName:o.item_productName,productDescription:o.item_productDescription,hsCode:o.item_hsCode,quantity:o.item_quantity,unitPrice:o.item_unitPrice,buyerBusinessName:o.buyerBusinessName,buyerNTNCNIC:o.buyerNTNCNIC});const u=String(o.invoiceType||o.invoice_type||"").trim().toLowerCase();if(u.includes("total")||u.includes("instruction")||u.includes("summary")||u.includes("note")||u.includes("auto-calculates")||u.includes("enter ")||u.includes("use the")||u.includes("dropdown")||u.includes("validated")||u.includes("hardcoded")||u.includes("fallback")||/^\d+\.\s/.test(u)||/^[a-z]\.\s/i.test(u))continue;const m=this.hasMeaningfulDataFlexible(o,i,a-1);a<=5&&console.log(`Row ${a} meaningful data check:`,{isMeaningful:m,hasData:Object.values(o).some(d=>String(d).trim()!==""),sampleData:{invoiceType:o.invoiceType,companyInvoiceRefNo:o.companyInvoiceRefNo,buyerBusinessName:o.buyerBusinessName,item_productName:o.item_productName},allData:o}),m&&r.push(o),a%100===0&&this.reportProgress(a/t*100,`Processed ${a} rows`)}return console.log(`Processed ${r.length} meaningful rows from ${t} total rows`),r.length>0&&console.log("üîç Worker Debug: Sample processed row:",{productName:r[0].item_productName,hsCode:r[0].item_hsCode,quantity:r[0].item_quantity,unitPrice:r[0].item_unitPrice,totalValues:r[0].item_totalValues,buyerBusinessName:r[0].buyerBusinessName}),r}parseCSVLine(e){const s=[];let i="",c=!1;for(let r=0;r<e.length;r++){const t=e[r];t==='"'?c&&e[r+1]==='"'?(i+='"',r++):c=!c:t===","&&!c?(s.push(i.trim()),i=""):i+=t}return s.push(i.trim()),s}normalizeHeader(e){const s=String(e||"").trim(),i={"Invoice Type":"invoiceType","Invoice Date":"invoiceDate","Invoice Ref No":"invoiceRefNo","Company Invoice Ref No":"companyInvoiceRefNo","Buyer NTN/CNIC":"buyerNTNCNIC","Buyer Buisness Name":"buyerBusinessName","Buyer Province":"buyerProvince","Buyer Address":"buyerAddress","Buyer Registration Type":"buyerRegistrationType","Transaction Type":"transctypeId",Rate:"item_rate","SRO Schedule No":"item_sroScheduleNo","SRO Item No":"item_sroItemSerialNo","Sale Type":"item_saleType","HS Code":"item_hsCode","Unit Of Measurement":"item_uoM","Product Name":"item_productName","Product Description":"item_productDescription","Value Sales (Excl ST)":"item_valueSalesExcludingST",Quantity:"item_quantity","Unit Cost":"item_unitPrice","Sales Tax Applicable":"item_salesTaxApplicable","ST Withheld at Source":"item_salesTaxWithheldAtSource","Extra Tax":"item_extraTax","Further Tax":"item_furtherTax","FED Payable":"item_fedPayable",Discount:"item_discount","Total Values":"item_totalValues",dn_invoice_ref_no:"invoiceRefNo",invoice_ref_no:"invoiceRefNo",invoice_ref_number:"invoiceRefNo",invoice_number:"invoiceRefNo",internal_invoice_no:"companyInvoiceRefNo",internal_invoice_number:"companyInvoiceRefNo",buyer_business_name:"buyerBusinessName",buyer_buisness_name:"buyerBusinessName",buyer_ntn_cnic:"buyerNTNCNIC",buyer_ntn:"buyerNTNCNIC",buyer_province:"buyerProvince",buyer_address:"buyerAddress",buyer_registration_type:"buyerRegistrationType",transaction_type:"transctypeId",transctype_id:"transctypeId",product_name:"item_productName",product_description:"item_productDescription",hs_code:"item_hsCode",hscode:"item_hsCode",quantity:"item_quantity",unit_price:"item_unitPrice",unit_cost:"item_unitPrice",total_values:"item_totalValues",value_sales_excluding_st:"item_valueSalesExcludingST",sales_tax_applicable:"item_salesTaxApplicable",st_withheld_at_source:"item_salesTaxWithheldAtSource",extra_tax:"item_extraTax",further_tax:"item_furtherTax",fed_payable:"item_fedPayable",discount:"item_discount",unit_of_measurement:"item_uoM",uom:"item_uoM",rate:"item_rate",sro_schedule_no:"item_sroScheduleNo",sro_item_serial_no:"item_sroItemSerialNo",sale_type:"item_saleType"};if(i[s])return i[s];const c={"Invoice Da":"invoiceDate","Invoice Re":"invoiceRefNo","Company I":"companyInvoiceRefNo","Buyer NTN":"buyerNTNCNIC","Buyer Buis":"buyerBusinessName","Buyer Prov":"buyerProvince","Buyer Addƒ±":"buyerAddress","Buyer Regi":"buyerRegistrationType",Transactio:"transctypeId","SRO Sched":"item_sroScheduleNo","SRO Item":"item_sroItemSerialNo","Product Na":"item_productName","Product De":"item_productDescription","Value Sale":"item_valueSalesExcludingST","Unit Of Me":"item_uoM","Sales Tax":"item_salesTaxApplicable","ST Withheld":"item_salesTaxWithheldAtSource","FED Payab":"item_fedPayable","Total Valu":"item_totalValues"};return c[s]?c[s]:s.toLowerCase().trim().replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}hasMeaningfulData(e,s){const i=e.invoiceType&&e.invoiceType.trim()!==""&&e.invoiceType!=="Standard"||e.invoiceDate&&e.invoiceDate.trim()!==""||e.companyInvoiceRefNo&&e.companyInvoiceRefNo.trim()!==""&&e.companyInvoiceRefNo!==`row_${s+1}`||e.buyerBusinessName&&e.buyerBusinessName.trim()!==""&&e.buyerBusinessName!=="Unknown Buyer"||e.buyerNTNCNIC&&e.buyerNTNCNIC.trim()!=="",c=e.item_productName&&e.item_productName.trim()!==""||e.item_hsCode&&e.item_hsCode.trim()!==""||e.item_quantity&&e.item_quantity!==""&&e.item_quantity!=="0"&&e.item_quantity!==0||e.item_unitPrice&&e.item_unitPrice!==""&&e.item_unitPrice!=="0"&&e.item_unitPrice!==0||e.item_totalValues&&e.item_totalValues!==""&&e.item_totalValues!=="0"&&e.item_totalValues!==0||e.item_valueSalesExcludingST&&e.item_valueSalesExcludingST!==""&&e.item_valueSalesExcludingST!=="0"&&e.item_valueSalesExcludingST!==0;return i||c}hasMeaningfulDataFlexible(e,s,i){const c=Object.values(e).some(n=>{const l=String(n).trim();return l!==""&&l!=="0"&&l!=="null"&&l!=="undefined"});if(!c)return console.log(`Row ${i+1}: No data found`),!1;const r=["auto-calculates","enter ","use the","dropdown","validated","hardcoded","fallback","computed as","divided by","instruction","note:","tip:","help:","example:"];return Object.entries(e).some(([n,l])=>{const o=String(l).toLowerCase().trim(),u=r.some(m=>o.startsWith(m)||o.includes(` ${m}`)||o.includes(`${m} `));return u&&console.log(`Row ${i+1}: Field '${n}' contains instruction pattern:`,{value:String(l),lowerValue:o,matchedPattern:r.find(m=>o.startsWith(m)||o.includes(` ${m}`)||o.includes(`${m} `))}),u})?(console.log(`Row ${i+1}: Contains instruction patterns - REJECTING`),!1):Object.values(e).some(n=>{const l=String(n).trim();return/^\d+\.\s/.test(l)||/^[a-z]\.\s/i.test(l)})?(console.log(`Row ${i+1}: Contains numbered list patterns`),!1):(console.log(`Row ${i+1}: Accepting as meaningful data`),c)}groupInvoices(e){const s=new Map,i=[],c=[];e.forEach((t,a)=>{try{const n=t.companyInvoiceRefNo?.trim()||t.company_invoice_ref_no?.trim()||t.invoice_ref_no?.trim()||t.dn_invoice_ref_no?.trim()||t.internalInvoiceNo?.trim()||t.internal_invoice_no?.trim()||t.invoiceNumber?.trim()||t.invoice_number?.trim()||`row_${a+1}`;if(s.has(n))s.get(n).items.push(this.cleanItemData(t,a));else{const l=t.buyerBusinessName||t.buyer_business_name||t.buyer_buisness_name||"";a<3&&console.log(`üîç Worker Debug: Creating invoice ${a+1}:`,{companyInvoiceRefNo:n,buyerBusinessName:l,buyerNTNCNIC:t.buyerNTNCNIC||t.buyer_ntn_cnic||"",availableFields:Object.keys(t).filter(o=>o.toLowerCase().includes("buyer"))}),s.set(n,{invoiceType:t.invoiceType||t.invoice_type||"Standard",invoiceDate:t.invoiceDate||t.invoice_date||new Date().toISOString().split("T")[0],companyInvoiceRefNo:n,internalInvoiceNo:t.internalInvoiceNo||t.internal_invoice_no||t.invoiceNumber||t.invoice_number||`INT-${a+1}`,buyerBusinessName:l,buyerNTNCNIC:t.buyerNTNCNIC||t.buyer_ntn_cnic||"",buyerProvince:t.buyerProvince||t.buyer_province||"",buyerAddress:t.buyerAddress||t.buyer_address||"",buyerRegistrationType:t.buyerRegistrationType||t.buyer_registration_type||"Individual",items:[this.cleanItemData(t,a)]})}}catch(n){i.push({row:a+1,message:n.message})}});const r=Array.from(s.values());return r.length>0&&console.log("üîç Worker Debug: Final invoice data:",{totalInvoices:r.length,sampleInvoice:{companyInvoiceRefNo:r[0].companyInvoiceRefNo,buyerBusinessName:r[0].buyerBusinessName,itemsCount:r[0].items?.length||0,sampleItem:r[0].items?.[0]?{item_productName:r[0].items[0].item_productName,item_hsCode:r[0].items[0].item_hsCode,item_quantity:r[0].items[0].item_quantity,item_unitPrice:r[0].items[0].item_unitPrice,item_totalValues:r[0].items[0].item_totalValues}:null}}),{invoices:r,errors:i,warnings:c}}cleanHsCode(e){if(!e||String(e).trim()===""||String(e).trim()==="N/A")return"";const s=String(e).trim();if(console.log("üîç Worker cleanHsCode input:",s.substring(0,100)+(s.length>100?"...":"")),s.includes(" - ")){const c=s.split(" - ")[0].trim();return console.log("üîç Worker cleanHsCode output:",c),c}return console.log("üîç Worker cleanHsCode output (no dash):",s),s}cleanItemData(e,s){const i={...e};return["quantity","unitPrice","totalValues","valueSalesExcludingST","fixedNotifiedValueOrRetailPrice","salesTaxApplicable","extraTax","furtherTax","fedPayable","discount","item_quantity","item_unitPrice","item_totalValues","item_valueSalesExcludingST","item_salesTaxApplicable","item_extraTax","item_furtherTax","item_fedPayable","item_discount"].forEach(t=>{if(i[t]!==void 0&&i[t]!==null&&i[t]!==""){const a=parseFloat(i[t]);i[t]=isNaN(a)?0:a}else i[t]=0}),Object.entries({item_productName:"name",item_hsCode:"hsCode",item_productDescription:"productDescription",item_quantity:"quantity",item_unitPrice:"unitPrice",item_totalValues:"totalValues",item_valueSalesExcludingST:"valueSalesExcludingST",item_salesTaxApplicable:"salesTaxApplicable",item_extraTax:"extraTax",item_furtherTax:"furtherTax",item_fedPayable:"fedPayable",item_discount:"discount",item_uoM:"uoM",item_rate:"rate"}).forEach(([t,a])=>{if(i[t]!==void 0){let n=i[t];t==="item_hsCode"&&(n=this.cleanHsCode(n)),i[a]=n,i[t]=n}}),i._row=s+1,i}reportProgress(e,s){this.progressCallback&&this.progressCallback(e,s),self.postMessage({type:"progress",percentage:e,message:s})}async process(e){if(this.isProcessing)throw new Error("Already processing a file");this.isProcessing=!0;try{this.reportProgress(0,"Starting file processing...");let s;if(e.type==="csv")this.reportProgress(10,"Parsing CSV file..."),s=this.processCSV(e.content,e.expectedColumns);else if(e.type==="excel")this.reportProgress(10,"Processing Excel data..."),s=this.processExcel(e.jsonData,e.expectedColumns);else throw new Error("Unsupported file type");this.reportProgress(70,"Grouping invoices...");const i=this.groupInvoices(s);return this.reportProgress(100,"Processing complete!"),{success:!0,data:i,totalRows:s.length,invoiceCount:i.invoices.length,errorCount:i.errors.length,warningCount:i.warnings.length}}catch(s){return{success:!1,error:s.message}}finally{this.isProcessing=!1}}}const p=new h;self.onmessage=async function(y){const{type:e,data:s}=y.data;switch(e){case"process":try{const i=await p.process(s);self.postMessage({type:"result",data:i})}catch(i){self.postMessage({type:"error",error:i.message})}break;case"cancel":p.isProcessing=!1,self.postMessage({type:"cancelled"});break}}})();
