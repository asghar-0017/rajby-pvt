(function(){"use strict";class f{constructor(){this.isProcessing=!1,this.progressCallback=null}processCSV(e,i){const t=e.split(`
`).filter(n=>n.trim());if(t.length<2)throw new Error("CSV file must have at least a header row and one data row");const c=this.parseCSVLine(t[0]).map(n=>this.normalizeHeader(n)),r=i.filter(n=>!c.includes(n));r.length>0&&console.warn(`Missing expected columns: ${r.join(", ")}. Processing with available columns.`);const s=[],l=t.length-1;for(let n=1;n<t.length;n++){const a=t[n].trim();if(!a)continue;const u=this.parseCSVLine(a),m={};c.forEach((o,d)=>{m[o]=u[d]||""}),s.push(m),n%100===0&&this.reportProgress(n/l*100,`Processed ${n} rows`)}return s}processExcel(e,i){if(e.length<2)throw new Error("Excel file must have at least a header row and one data row");const t=e[0].map(a=>this.normalizeHeader(a));console.log("Available headers in Excel file:",t),console.log("Expected columns:",i);const c=t.filter(a=>a.includes("dcDoc"));console.log("DC Doc related headers found:",c);const r=t.filter(a=>a.toLowerCase().includes("dc")||a.toLowerCase().includes("doc")||a.toLowerCase().includes("document"));console.log("All DC/Doc related headers found:",r),console.log("Raw headers from Excel (before normalization):",e[0]);const s=i.filter(a=>!t.includes(a));s.length>0&&console.warn(`Missing expected columns: ${s.join(", ")}. Processing with available columns.`),e[0].forEach((a,u)=>{t[u]});const l=[],n=e.length-1;for(let a=1;a<e.length;a++){const u=e[a];if(!u||!Array.isArray(u)||!u.slice(0,5).some(_=>_!=null&&String(_).trim()!==""))continue;const o={};t.forEach((_,p)=>{let N=u[p]!==null&&u[p]!==void 0?String(u[p]).trim():"";o[_]=N}),a<=3&&console.log(`Excel Row ${a} data:`,{...o,productName:o.item_productName,productDescription:o.item_productDescription,hsCode:o.item_hsCode,quantity:o.item_quantity,unitPrice:o.item_unitPrice,buyerBusinessName:o.buyerBusinessName,buyerNTNCNIC:o.buyerNTNCNIC,dcDocId:o.item_dcDocId,dcDocDate:o.item_dcDocDate});const d=String(o.invoiceType||o.invoice_type||"").trim().toLowerCase();if(d.includes("total")||d.includes("instruction")||d.includes("summary")||d.includes("note")||d.includes("auto-calculates")||d.includes("enter ")||d.includes("use the")||d.includes("dropdown")||d.includes("validated")||d.includes("hardcoded")||d.includes("fallback")||/^\d+\.\s/.test(d)||/^[a-z]\.\s/i.test(d))continue;const g=this.hasMeaningfulDataFlexible(o,t,a-1);a<=5&&console.log(`Row ${a} meaningful data check:`,{isMeaningful:g,hasData:Object.values(o).some(_=>String(_).trim()!==""),sampleData:{invoiceType:o.invoiceType,companyInvoiceRefNo:o.companyInvoiceRefNo,buyerBusinessName:o.buyerBusinessName,item_productName:o.item_productName},allData:o}),g&&l.push(o),a%100===0&&this.reportProgress(a/n*100,`Processed ${a} rows`)}return console.log(`Processed ${l.length} meaningful rows from ${n} total rows`),l.length>0&&console.log("üîç Worker Debug: Sample processed row:",{productName:l[0].item_productName,hsCode:l[0].item_hsCode,quantity:l[0].item_quantity,unitPrice:l[0].item_unitPrice,totalValues:l[0].item_totalValues,buyerBusinessName:l[0].buyerBusinessName}),l}parseCSVLine(e){const i=[];let t="",c=!1;for(let r=0;r<e.length;r++){const s=e[r];s==='"'?c&&e[r+1]==='"'?(t+='"',r++):c=!c:s===","&&!c?(i.push(t.trim()),t=""):t+=s}return i.push(t.trim()),i}normalizeHeader(e){const i=String(e||"").trim(),t={"Invoice Type":"invoiceType","Invoice Date":"invoiceDate","Invoice Ref No":"invoiceRefNo","Company Invoice Ref No":"companyInvoiceRefNo","Buyer NTN/CNIC":"buyerNTNCNIC","Buyer Buisness Name":"buyerBusinessName","Buyer Province":"buyerProvince","Buyer Address":"buyerAddress","Buyer Registration Type":"buyerRegistrationType","Buyer Telephone No":"buyerTelephone","Transaction Type":"transctypeId",Rate:"item_rate","SRO Schedule No":"item_sroScheduleNo","SRO Item No":"item_sroItemSerialNo","DC Doc Id":"item_dcDocId","DC Doc Date":"item_dcDocDate","Sale Type":"item_saleType","HS Code":"item_hsCode","Unit Of Measurement":"item_uoM","Product Name":"item_productName","Product Description":"item_productDescription","Value Sales (Excl ST)":"item_valueSalesExcludingST",Quantity:"item_quantity","Unit Cost":"item_unitPrice","Sales Tax Applicable":"item_salesTaxApplicable","ST Withheld at Source":"item_salesTaxWithheldAtSource","Extra Tax":"item_extraTax","Further Tax":"item_furtherTax","FED Payable":"item_fedPayable",Discount:"item_discount","Total Values":"item_totalValues",dn_invoice_ref_no:"invoiceRefNo",invoice_ref_no:"invoiceRefNo",invoice_ref_number:"invoiceRefNo",invoice_number:"invoiceRefNo",internal_invoice_no:"companyInvoiceRefNo",internal_invoice_number:"companyInvoiceRefNo",buyer_business_name:"buyerBusinessName",buyer_buisness_name:"buyerBusinessName",buyer_ntn_cnic:"buyerNTNCNIC",buyer_ntn:"buyerNTNCNIC",buyer_province:"buyerProvince",buyer_address:"buyerAddress",buyer_registration_type:"buyerRegistrationType",transaction_type:"transctypeId",transctype_id:"transctypeId",product_name:"item_productName",product_description:"item_productDescription",hs_code:"item_hsCode",hscode:"item_hsCode",quantity:"item_quantity",unit_price:"item_unitPrice",unit_cost:"item_unitPrice",total_values:"item_totalValues",value_sales_excluding_st:"item_valueSalesExcludingST",sales_tax_applicable:"item_salesTaxApplicable",st_withheld_at_source:"item_salesTaxWithheldAtSource",extra_tax:"item_extraTax",further_tax:"item_furtherTax",fed_payable:"item_fedPayable",discount:"item_discount",unit_of_measurement:"item_uoM",uom:"item_uoM",rate:"item_rate",sro_schedule_no:"item_sroScheduleNo",sro_item_serial_no:"item_sroItemSerialNo",sale_type:"item_saleType"};if(t[i])return t[i];const c={"Invoice Da":"invoiceDate","Invoice Re":"invoiceRefNo","Company I":"companyInvoiceRefNo","Buyer NTN":"buyerNTNCNIC","Buyer Buis":"buyerBusinessName","Buyer Prov":"buyerProvince","Buyer Addƒ±":"buyerAddress","Buyer Regi":"buyerRegistrationType","Buyer Tele":"buyerTelephone",Transactio:"transctypeId","SRO Sched":"item_sroScheduleNo","SRO Item":"item_sroItemSerialNo","DC Doc I":"item_dcDocId","DC Doc Da":"item_dcDocDate","Product Na":"item_productName","Product De":"item_productDescription","Value Sale":"item_valueSalesExcludingST","Unit Of Me":"item_uoM","Sales Tax":"item_salesTaxApplicable","ST Withheld":"item_salesTaxWithheldAtSource","FED Payab":"item_fedPayable","Total Valu":"item_totalValues"};return c[i]?c[i]:i.toLowerCase().trim().replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}hasMeaningfulData(e,i){const t=e.invoiceType&&e.invoiceType.trim()!==""&&e.invoiceType!=="Standard"||e.invoiceDate&&e.invoiceDate.trim()!==""||e.companyInvoiceRefNo&&e.companyInvoiceRefNo.trim()!==""&&e.companyInvoiceRefNo!==`row_${i+1}`||e.buyerBusinessName&&e.buyerBusinessName.trim()!==""&&e.buyerBusinessName!=="Unknown Buyer"||e.buyerNTNCNIC&&e.buyerNTNCNIC.trim()!=="",c=e.item_productName&&e.item_productName.trim()!==""||e.item_hsCode&&e.item_hsCode.trim()!==""||e.item_quantity&&e.item_quantity!==""&&e.item_quantity!=="0"&&e.item_quantity!==0||e.item_unitPrice&&e.item_unitPrice!==""&&e.item_unitPrice!=="0"&&e.item_unitPrice!==0||e.item_totalValues&&e.item_totalValues!==""&&e.item_totalValues!=="0"&&e.item_totalValues!==0||e.item_valueSalesExcludingST&&e.item_valueSalesExcludingST!==""&&e.item_valueSalesExcludingST!=="0"&&e.item_valueSalesExcludingST!==0;return t||c}hasMeaningfulDataFlexible(e,i,t){const c=Object.values(e).some(n=>{const a=String(n).trim();return a!==""&&a!=="0"&&a!=="null"&&a!=="undefined"});if(!c)return console.log(`Row ${t+1}: No data found`),!1;const r=["auto-calculates","enter ","use the","dropdown","validated","hardcoded","fallback","computed as","divided by","instruction","note:","tip:","help:","example:"];return Object.entries(e).some(([n,a])=>{const u=String(a).toLowerCase().trim(),m=r.some(o=>u.startsWith(o)||u.includes(` ${o}`)||u.includes(`${o} `));return m&&console.log(`Row ${t+1}: Field '${n}' contains instruction pattern:`,{value:String(a),lowerValue:u,matchedPattern:r.find(o=>u.startsWith(o)||u.includes(` ${o}`)||u.includes(`${o} `))}),m})?(console.log(`Row ${t+1}: Contains instruction patterns - REJECTING`),!1):Object.values(e).some(n=>{const a=String(n).trim();return/^\d+\.\s/.test(a)||/^[a-z]\.\s/i.test(a)})?(console.log(`Row ${t+1}: Contains numbered list patterns`),!1):(console.log(`Row ${t+1}: Accepting as meaningful data`),c)}groupInvoices(e){const i=new Map,t=[],c=[];e.forEach((s,l)=>{try{const n=s.companyInvoiceRefNo?.trim()||s.company_invoice_ref_no?.trim()||s.invoice_ref_no?.trim()||s.dn_invoice_ref_no?.trim()||s.internalInvoiceNo?.trim()||s.internal_invoice_no?.trim()||s.invoiceNumber?.trim()||s.invoice_number?.trim()||`row_${l+1}`;if(i.has(n))i.get(n).items.push(this.cleanItemData(s,l));else{const a=s.buyerBusinessName||s.buyer_business_name||s.buyer_buisness_name||"";l<3&&console.log(`üîç Worker Debug: Creating invoice ${l+1}:`,{companyInvoiceRefNo:n,buyerBusinessName:a,buyerNTNCNIC:s.buyerNTNCNIC||s.buyer_ntn_cnic||"",availableFields:Object.keys(s).filter(u=>u.toLowerCase().includes("buyer"))}),i.set(n,{invoiceType:s.invoiceType||s.invoice_type||"Standard",invoiceDate:s.invoiceDate||s.invoice_date||new Date().toISOString().split("T")[0],companyInvoiceRefNo:n,internalInvoiceNo:s.internalInvoiceNo||s.internal_invoice_no||s.invoiceNumber||s.invoice_number||`INT-${l+1}`,buyerBusinessName:a,buyerNTNCNIC:s.buyerNTNCNIC||s.buyer_ntn_cnic||"",buyerProvince:s.buyerProvince||s.buyer_province||"",buyerAddress:s.buyerAddress||s.buyer_address||"",buyerRegistrationType:s.buyerRegistrationType||s.buyer_registration_type||"Individual",buyerTelephone:s.buyerTelephone||s.buyer_telephone_no||s.buyer_telephone||"",items:[this.cleanItemData(s,l)]})}}catch(n){t.push({row:l+1,message:n.message})}});const r=Array.from(i.values());return r.length>0&&console.log("üîç Worker Debug: Final invoice data:",{totalInvoices:r.length,sampleInvoice:{companyInvoiceRefNo:r[0].companyInvoiceRefNo,buyerBusinessName:r[0].buyerBusinessName,itemsCount:r[0].items?.length||0,sampleItem:r[0].items?.[0]?{item_productName:r[0].items[0].item_productName,item_hsCode:r[0].items[0].item_hsCode,item_quantity:r[0].items[0].item_quantity,item_unitPrice:r[0].items[0].item_unitPrice,item_totalValues:r[0].items[0].item_totalValues}:null}}),{invoices:r,errors:t,warnings:c}}cleanHsCode(e){if(!e||String(e).trim()===""||String(e).trim()==="N/A")return"";const i=String(e).trim();if(console.log("üîç Worker cleanHsCode input:",i.substring(0,100)+(i.length>100?"...":"")),i.includes(" - ")){const c=i.split(" - ")[0].trim();return console.log("üîç Worker cleanHsCode output:",c),c}return console.log("üîç Worker cleanHsCode output (no dash):",i),i}cleanItemData(e,i){i<3&&console.log(`üîç Worker Debug: Processing item ${i+1}:`,{item_cartages:e.item_cartages,item_others:e.item_others,cartages:e.cartages,others:e.others,allKeys:Object.keys(e).filter(r=>r.includes("cartages")||r.includes("others"))});const t={productName:e.productName||e.item_productName||e.name||"",name:e.name||e.item_productName||e.productName||"",hsCode:e.hsCode||e.item_hsCode||"",productDescription:e.productDescription||e.item_productDescription||"",rate:e.rate||e.item_rate||0,uoM:e.uoM||e.item_uoM||"",quantity:e.quantity||e.item_quantity||0,unitPrice:e.unitPrice||e.item_unitPrice||0,totalValues:e.totalValues||e.item_totalValues||0,valueSalesExcludingST:e.valueSalesExcludingST||e.item_valueSalesExcludingST||0,fixedNotifiedValueOrRetailPrice:e.fixedNotifiedValueOrRetailPrice||e.item_fixedNotifiedValueOrRetailPrice||0,salesTaxApplicable:e.salesTaxApplicable||e.item_salesTaxApplicable||0,extraTax:e.extraTax||e.item_extraTax||0,furtherTax:e.furtherTax||e.item_furtherTax||0,sroScheduleNo:e.sroScheduleNo||e.item_sroScheduleNo||"",fedPayable:e.fedPayable||e.item_fedPayable||0,discount:e.discount||e.item_discount||0,cartages:e.item_cartages||e.cartages||0,others:e.item_others||e.others||0,saleType:e.saleType||e.item_saleType||"",sroItemSerialNo:e.sroItemSerialNo||e.item_sroItemSerialNo||"",dcDocId:e.dcDocId||e.item_dcDocId||"",dcDocDate:e.dcDocDate||e.item_dcDocDate||"",item_rate:e.item_rate||0,item_sroScheduleNo:e.item_sroScheduleNo||"",item_sroItemSerialNo:e.item_sroItemSerialNo||"",item_saleType:e.item_saleType||"",item_hsCode:e.item_hsCode||"",item_uoM:e.item_uoM||"",item_productName:e.item_productName||"",item_productDescription:e.item_productDescription||"",item_valueSalesExcludingST:e.item_valueSalesExcludingST||0,item_quantity:e.item_quantity||0,item_unitPrice:e.item_unitPrice||0,item_salesTaxApplicable:e.item_salesTaxApplicable||0,item_salesTaxWithheldAtSource:e.item_salesTaxWithheldAtSource||0,item_extraTax:e.item_extraTax||0,item_furtherTax:e.item_furtherTax||0,item_fedPayable:e.item_fedPayable||0,item_discount:e.item_discount||0,item_cartages:e.item_cartages||e.cartages||0,item_others:e.item_others||e.others||0,item_totalValues:e.item_totalValues||0,item_dcDocId:e.item_dcDocId||"",item_dcDocDate:e.item_dcDocDate||"",item_fixedNotifiedValueOrRetailPrice:e.item_fixedNotifiedValueOrRetailPrice||0,transctypeId:e.transctypeId||"",_row:i+1};if(["quantity","unitPrice","totalValues","valueSalesExcludingST","fixedNotifiedValueOrRetailPrice","salesTaxApplicable","extraTax","furtherTax","fedPayable","discount","item_quantity","item_unitPrice","item_totalValues","item_valueSalesExcludingST","item_salesTaxApplicable","item_extraTax","item_furtherTax","item_fedPayable","item_discount"].forEach(r=>{if(t[r]!==void 0&&t[r]!==null&&t[r]!==""){const s=parseFloat(t[r]);t[r]=isNaN(s)?0:s}else t[r]=0}),t.hsCode&&(t.hsCode=this.cleanHsCode(t.hsCode)),t.item_hsCode&&(t.item_hsCode=this.cleanHsCode(t.item_hsCode)),t.transctypeId){const r=String(t.transctypeId).trim();if(r.includes(" - ")){const s=r.split(" - ");t.transctypeId=s[0].trim()}}return i<3&&console.log(`üîç Worker Debug: Cleaned item ${i+1}:`,{cartages:t.cartages,others:t.others,item_cartages:t.item_cartages,item_others:t.item_others}),t}reportProgress(e,i){this.progressCallback&&this.progressCallback(e,i),self.postMessage({type:"progress",percentage:e,message:i})}async process(e){if(this.isProcessing)throw new Error("Already processing a file");this.isProcessing=!0;try{this.reportProgress(0,"Starting file processing...");let i;if(e.type==="csv")this.reportProgress(10,"Parsing CSV file..."),i=this.processCSV(e.content,e.expectedColumns);else if(e.type==="excel")this.reportProgress(10,"Processing Excel data..."),i=this.processExcel(e.jsonData,e.expectedColumns);else throw new Error("Unsupported file type");this.reportProgress(70,"Grouping invoices...");const t=this.groupInvoices(i);return this.reportProgress(100,"Processing complete!"),{success:!0,data:t,totalRows:i.length,invoiceCount:t.invoices.length,errorCount:t.errors.length,warningCount:t.warnings.length}}catch(i){return{success:!1,error:i.message}}finally{this.isProcessing=!1}}}const y=new f;self.onmessage=async function(h){const{type:e,data:i}=h.data;switch(e){case"process":try{const t=await y.process(i);self.postMessage({type:"result",data:t})}catch(t){self.postMessage({type:"error",error:t.message})}break;case"cancel":y.isProcessing=!1,self.postMessage({type:"cancelled"});break}}})();
